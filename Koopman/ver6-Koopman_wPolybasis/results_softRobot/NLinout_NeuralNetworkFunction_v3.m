function [y1,xf1] = NLinout_NeuralNetworkFunction_v3(x1,xi1)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 24-Aug-2018 17:35:50.
%
% [y1,xf1] = myNeuralNetworkFunction(x1,xi1) takes these arguments:
%   x1 = 3xTS matrix, input #1
%   xi1 = 3x2 matrix, initial 2 delay states for input #1.
% and returns:
%   y1 = 6xTS matrix, output #1
%   xf1 = 3x2 matrix, final 2 delay states for input #1.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0;0;0];
x1_step1.gain = [0.20053699350483;0.200544041106296;0.200280392549569];
x1_step1.ymin = -1;

% Layer 1
b1 = [-0.48002694668185703;-0.51813942382548439;-0.13021979518363405;-0.30476955250890614;0.091139660849844678;1.6814838237250855;-0.69051344369946255;0.1009584806467298;3.9806498207323751;-0.070989217190588094;-0.0069301342650105319;0.64893288510767488;-0.072888654572908593;-0.024615328942621376;0.080284671661881676;0.023617136346398927;-0.3243063235481552;0.10121117526810053;1.1723324470397161;35.69498709372737];
IW1_1 = [17.344409988430701 -11.380086115924588 4.2465120651170869 -17.846174410727109 11.910701850938048 -4.2710631580149139;18.703403514700881 -12.462333542552958 3.6597213278977634 -19.231111983622849 13.009300058294491 -3.6678048668621779;4.7550178428948291 7.0572686015535631 -222.81277641127349 -4.7896969010737545 -7.1009868071765432 223.59478627692292;-4.8708370438198783 42.830603923252738 -130.15292357203873 5.3367106551912959 -43.314356555288768 130.15935512290801;184.88442443766024 10.503914951760054 -8.3097773270689412 -185.86393980420991 -10.500955253478791 8.3690510121012522;-1.2722088500328905 20.851979225301776 22.109280298510377 -5.0240622262217496 -19.823964090325131 -2.2504937370195344;-0.27273361903734833 -2.3988863536070983 2.3383712790681774 0.39579708284122306 2.6310659356607471 -2.7798674990209178;-1.4895080847981996 -16.654937745143858 513.57934132451635 1.5459481199309044 16.605076029894647 -514.02939326939816;5.8668013938845496 14.248118719718045 79.831623716845556 -5.9315773416636715 -9.971889049296415 -80.401558034467229;-2.1366024891878093 -450.65743754145086 -4.6909528569839578 2.1325352202782581 451.23180815562381 4.6531019322274769;111.16831422490931 13.116790824368309 13.198474407438873 -110.67538302573601 -12.782478436348057 -13.275668102749876;-0.4629720544074501 1.9805017296776974 -0.87753546540726124 0.35637540401313922 -2.1685518863570983 1.2495407264647755;-3.2477346105024893 -401.29009258934241 -5.8791685831296583 3.2206034021335324 401.87971657574872 5.8533040573997459;-400.70164051157963 -2.0767571425557634 16.182231688940085 401.02692360108085 2.1297734153102961 -16.215716186630495;4.5947153979280202 325.30197708418029 7.8567109628914533 -4.5146280815043172 -325.99773315818788 -7.8486061005555978;374.33740051087051 2.8419348534496831 -15.470030947604876 -374.64205216162924 -2.8986669906671074 15.503028637068054;27.752312205955935 -108.53527405792271 16.286471370190391 -27.504377949937329 110.26865129755403 -16.737891824252234;-1.2398904963603432 -15.497840060095388 478.62284863815643 1.2887409440291613 15.450226415054495 -479.05446886463636;89.735045223481151 42.153928772618706 32.66086810253676 -89.886126738918719 -42.191399343475624 -33.451091059165527;-2.4111191013096454 13.422543618713304 14.847386762328172 -1.0893403025461665 25.743265638353602 -9.9070934459552547];

% Layer 2
b2 = [0.2355227956204447;-0.21335932765301868;0.72918118045838254;-0.22259802446232235;-0.45793191688610746;0.16018452078550663];
LW2_1 = [-0.53885340813487503 0.46221789253952034 -0.032223460395561204 -0.06691943220639425 0.61330622152034808 0.012276302484953398 -1.8913580238300214 0.90480428691426151 -0.1017291960682023 11.466457653298683 0.18322899135769657 -2.3645040675484172 -16.830224944705776 -8.2755363951802519 -5.6568610223887665 -8.7184202378791547 -0.02162488965646504 -0.9511265045854167 -0.079385700178124602 0.043436544702503729;-1.1018715813549151 0.93146863617546027 0.86803863349822452 -0.094056691561473338 0.2320752497309698 0.023234789949781558 1.292199378817311 -9.0347817700859974 0.060617949901528766 -5.4180089631146728 -0.061342576453467149 1.2944099268836322 8.0186941953129427 -2.4632443269389608 2.7534375313643018 -2.5128983345212821 0.0059592707881483305 9.511015281352881 -0.0057249692604003461 0.0091305275142696055;17.190384872412316 -16.944113658884053 -0.1228933542042628 -0.21077838956328615 0.3177104338143541 -0.0027958940056498544 -17.334142139869641 2.1376913675144769 0.037210633093559022 -2.8021218428592589 0.094247987202320832 -19.300152364838915 4.1669341508306337 -2.7539439373200452 1.4251232612815898 -2.9062689892209912 -0.076284708526289588 -2.281739506879652 -0.25290912617770972 -0.0081536236127438683;5.1741187952241869 -4.7090195567146269 -0.027901642688552386 0.10602556296563242 -0.075260289338017095 -0.0054777514212824372 1.8382837940425352 -0.59982723812328509 0.094643655634683341 -5.6236007235168213 -0.16598998307983182 2.5018349314141353 7.8076662488432422 4.8641148379687298 2.2110839965753906 5.0820107224122539 0.15682449700876722 0.61998889493732856 -0.0060119651180337921 -0.052239418145784575;-0.38005831532237111 0.40484485284003985 -0.025912489411087734 -0.068421432589489378 0.027362500274415492 -0.0077124627276218549 2.5761523283029444 5.2122408726978513 -0.016331972620580358 2.6211761074089792 -0.0043013728739197399 3.513655195889402 -3.575719802472189 1.7831768343757353 -0.95032893840733745 1.8156199006542271 -0.054417267935717321 -5.3498271073310431 -0.016732863727372305 0.0013171738322022069;10.303758442686334 -10.147393069685922 0.0017549639922400944 -0.080320367708026821 0.052229765300768873 0.00077346475175458108 -9.1444580597431777 -0.11752531036948348 0.0094829601459949561 0.31697959005730664 -0.068498397255349605 -10.067254067755306 -0.25931059438623061 1.3163748435682765 0.060766051969968211 1.3536430905069319 -0.0016784783709275159 0.10487376868721052 -0.094889605177075509 0.0043614268867228556];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [6.02925470600584;5.80239714539318;19.5174170890666;7.66459323490276;7.02419411493605;19.1826794012276];
y1_step1.xoffset = [-0.156274843142796;-0.148885540376267;-0.106342153265596;-0.133510159664189;-0.139378367975141;-0.0515426322556757];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(3,1)];

% Allocate Outputs
y1 = zeros(6,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end

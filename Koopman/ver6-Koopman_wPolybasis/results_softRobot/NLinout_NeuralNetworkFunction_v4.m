function [y1,xf1] = NLinout_NeuralNetworkFunction_v4(x1,xi1)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 24-Aug-2018 20:46:47.
%
% [y1,xf1] = myNeuralNetworkFunction(x1,xi1) takes these arguments:
%   x1 = 3xTS matrix, input #1
%   xi1 = 3x2 matrix, initial 2 delay states for input #1.
% and returns:
%   y1 = 6xTS matrix, output #1
%   xf1 = 3x2 matrix, final 2 delay states for input #1.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0;0;0];
x1_step1.gain = [0.20053699350483;0.200544041106296;0.200280392549569];
x1_step1.ymin = -1;

% Layer 1
b1 = [28.761680241708675;-0.097418485891732409;-0.0053990496360787907;3.8228178035558527;-26.140162338712678;2.0521439118493343;-0.011827146327425759;-0.42304305558473704;0.26083514356955673;0.15852891963438365;0.29507865350548529;-0.41256388589052373;-0.079802057677060417;0.17983045186148355;-0.062207188385401596;-0.098767082330230127;-0.059947624690427422;-0.11707213784284681;-1.2088386234056137;-0.28226978111589468;0.0034485678207128259;-0.49178737414089918;-0.12524097560795391;0.21462010588194141;-0.056930663012539219;1.2083109240810455;0.42276361305043347;-9.0936182583454528;0.27473915766130508;52.338923075365848];
IW1_1 = [6.5030212424838387 -39.826827862852994 -21.125081494442494 -59.665300642431873 40.39329544163364 24.006513048909561;21.06644748575593 -1125.6518099766611 3.7590089294835685 -21.042533707893654 1126.0530339654333 -3.7670692123542673;-278.03803216618104 -9.8422030251228012 22.703609387820851 278.8154780174109 9.9102819408947678 -22.648888957071893;-1.6984324496189871 3.1424702792118664 -1.1843691547158011 1.4535716655919648 -1.4487786742530842 1.1827593476141771;9.9186526586779866 -26.530565519554113 21.989229932856937 -7.2082659976050749 -2.2412147614398799 -26.057268968206163;48.978825735723092 78.939367045143058 -18.999989432167936 -51.516915136452482 -76.472613898981066 17.267889578697634;489.34613286569925 -2.1116927648633346 275.16569776099317 -489.86643473942826 2.5399911377553761 -275.22837030477871;-2.1826629665836492 -37.142137121677962 92.118539912500367 2.417342752590506 37.576721069380859 -93.093376484358771;-2.6994532047428859 -21.653089288470937 79.548816080494063 2.8356374887384206 22.284452139015151 -80.276963732206099;0.34139613955577264 32.922906713992155 -82.384167330922097 -0.54874110521722974 -33.247489035596999 83.229532785833783;-45.054508741783849 2.2534185405140343 -50.226441323483975 45.363025055343805 -2.2033795808569696 50.50287786847943;58.262935133515079 1.8748298589986521 -0.2257428832090061 -58.891929842954752 -0.83536638157408927 -0.06240274474922123;-44.466383492276663 14.232676282253435 -573.50379484593975 44.534899011466791 -14.169706927026956 573.39074481240334;-2.7368657542874884 255.81267345370617 -5.7253611714834118 2.961078835598034 -257.37525981097508 5.7674224860915837;-1057.7415091298744 -34.57201425379408 29.870216632567033 1058.3313000192438 34.528019199341948 -30.215417105123759;24.299155308181692 -1222.9490528428837 3.5892990424178315 -24.265929154579904 1223.4291539745805 -3.612571509201536;-1157.5890443572293 -28.739697223774002 31.602580117034975 1158.2162956727941 28.686530441761306 -31.907776380833059;25.655387425535455 -16.638278605721048 74.033780764964646 -26.223248024219096 16.569227561638012 -73.835733878359548;56.897807199052615 27.716315122781339 -42.761609953779605 -57.804828348539715 -27.46588123675205 43.129341927619315;44.175601890699078 -3.3073334143427315 50.701738041338167 -44.496974884756916 3.2537920639407969 -50.962710623951899;281.95741031542076 10.357198705601085 -23.484808031855458 -282.71574068283269 -10.430749922797455 23.435705431551348;-8.8894678668935949 20.16346325875632 3.9664431823475867 9.3127875124539496 -20.498801423120476 -3.982810358140489;-9.8227101496761584 61.035386032422856 -1575.6503178778191 9.6870305870695894 -60.960279176700155 1576.4157709072456;-15.399532341410911 -11.567738061510738 295.62598880551457 15.312467515978051 11.421816030881038 -296.99939573225254;-733.90368710760549 -50.762353248876977 31.019924657820486 734.48343491198091 50.787592257692033 -31.460332165562086;-57.044544629702656 -27.053167878503181 42.618837110575136 57.957660575036442 26.807529784071498 -42.995711579310701;-57.487404366179746 -2.1630594502122356 0.40644133604575489 58.107088720132346 1.1507712373461565 -0.12488695507666707;-24.995164536508423 6.7591579350775124 -30.155968375792707 17.954692221183191 -9.0862761036730539 31.250278058173699;-2.7387828288567198 -23.336935673409851 80.607286570805812 2.8850151338335106 23.945235264937601 -81.346681194689836;31.734185335258825 -44.500671138822923 18.759828664413728 -13.38383219408577 -10.218571045246177 -15.224023384479493];

% Layer 2
b2 = [6.3929314909594632;-2.5694086778142951;-0.75682680190465645;-4.7795769672411188;1.0509651369261834;-1.5681058818005367];
LW2_1 = [-0.015048180770195088 -2.8166089244592301 -18.185130299097093 -6.6151462611948881 -0.057502880244241605 0.034891107540601415 0.0068680588681244766 -1.2994830816004297 7.2777588634500443 -1.9295494664285857 -11.376949673746307 -6.9928817490223087 0.063575555504894049 -0.2443276423431974 5.2433900784518492 2.883084639513033 -4.3917329774180827 0.59178064143377773 2.4447372778666274 -12.163280670430044 -18.304566468941104 -0.16568270484284589 -0.04986213543374473 -0.0057122449275808767 -1.2622994182119234 2.5325955940460703 -7.1708084968774246 -0.048130864506811102 -7.8078705798712331 0.042591764130078431;0.011766571013122739 1.4052744057613791 -5.0363515656601425 2.5730088433094727 -0.021989389402134175 0.024081604181837177 -0.098650151982260084 3.0869845033635883 -19.444313255715297 4.5878581950829433 -4.2743600016854693 6.2263864647312905 -0.27105028157302063 0.14259705353648386 3.8775424488109098 -1.4168117438577159 -3.21525182411458 0.34659858837361718 5.6254684131029231 -4.3785635263558333 -5.0238048894963017 0.10959343193670873 0.29837762878674962 -0.1653122124217174 -0.85879358049188304 5.4957872988659595 6.3835738052041409 0.14129237303567177 20.680063297093842 -0.015549622455496476;-0.018448731196509669 0.83104981964979452 -8.8705526454931238 -0.064537612187853255 -0.010872847021983784 -0.022282802247131011 -0.021922514020430415 -0.96069218820166558 -1.4691998728150957 -0.45980371519535285 -18.223859746855837 13.514161072247065 0.049926643975373539 0.079188179516650734 2.5783108492942803 -0.83041556197798383 -2.1273661034927605 0.27303599847813592 32.347436788870269 -17.99728228395708 -8.9540484259949746 -1.3024464619945375 -0.047429678095893657 0.055823953005905785 -0.68638487578155671 32.241690257111514 14.375618204737394 -0.173874738395627 1.7787721099114158 -0.00039805482992848998;0.013322190336691344 2.1219375058245538 5.4180516445863631 4.86212364388021 0.048356349892982042 0.023756975734855915 -0.0045429215497127398 0.94669873094107493 -5.7812220987078637 1.3107068024108219 5.7668968588177529 3.0967137855255968 0.018628775421577055 -0.079789410527747101 -3.9345146263256758 -2.1821634728401107 3.4324372133008301 -0.055550402970293997 7.148389012782256 5.8955846971237049 5.6307701310361296 -0.075830498666623558 0.0091886169396257801 0.031285519085783385 0.69916360918876996 7.1707187141861359 2.9779695154381645 0.042348874346058524 6.0703348272104893 -0.039731507501031472;0.0044456117412451108 -0.94440762976669246 1.3999713678335663 -1.1982874872035711 0.0076350433280122391 -0.035653085723251619 0.031783521756153878 -0.47054731843076908 4.9415000722012206 -0.55178789405940976 0.36715635932858715 -1.6336721589887222 0.21102596720653496 0.04559110170409033 -3.0438795972710748 0.96616302948732968 2.4986099768642798 0.14347164815607383 -4.9099791385738385 0.31189739305203718 1.5907874904604704 -0.12711235228887813 -0.24817847600257298 -0.085387273568944058 0.71580988398746537 -4.8668416598544715 -1.6092912357643707 -0.068027970783114344 -5.150451534674314 0.020095594487730916;0.0084244560902180399 -0.42667813860228931 0.73915606818787927 1.0674351279592544 -0.0016995045921690984 0.0085209468523112578 -0.010511202845956686 -0.37536467570626086 -0.45412118377795113 -0.15173708916101877 -1.1860585983104188 7.6773317465135342 0.013676697429620532 0.031532936968557655 -1.081316567687798 0.43885812484786429 0.97741291048275758 -0.028692557258771477 17.679229759409559 -0.89476076637009194 0.81370581745788906 -0.5263177555776517 -0.0022077043880467649 -0.0067047715475418643 0.15278376835774798 17.639812075690013 8.10850656187319 -0.024329373888044712 0.61390769651840438 0.022220369851163227];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [6.02925470600584;5.80239714539318;19.5174170890666;7.66459323490276;7.02419411493605;19.1826794012276];
y1_step1.xoffset = [-0.156274843142796;-0.148885540376267;-0.106342153265596;-0.133510159664189;-0.139378367975141;-0.0515426322556757];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(3,1)];

% Allocate Outputs
y1 = zeros(6,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end

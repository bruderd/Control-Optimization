function [y1,xf1,xf2] = dp4narxnetFunction(x1,x2,xi1,xi2)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 13-Aug-2018 11:00:21.
%
% [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 1xTS matrix, input #1
%   x2 = 4xTS matrix, input #2
%   xi1 = 1x2 matrix, initial 2 delay states for input #1.
%   xi2 = 4x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 4xTS matrix, output #1
%   xf1 = 1x2 matrix, final 2 delay states for input #1.
%   xf2 = 4x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = -4.97987577554016;
x1_step1.gain = 0.200886392612375;
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-1.89414184126235;-2.36502124594879;-4.45419934918392;-7.44556467563318];
x2_step1.gain = [0.523617186407085;0.459064467788146;0.223430193966737;0.127210752845805];
x2_step1.ymin = -1;

% Layer 1
b1 = [2.2088463848169981;-2.3526047144973385;0.89626595593552849;0.022040877512172867;0.019813970229919931;-0.040169493919627229;-1.1659532640493575;-0.095234366515981272;-0.052951656330519271;3.387530826841326];
IW1_1 = [-0.41809532282297956 0.068555354768592563;0.21287115517946892 -0.12079849100578169;0.15322284011622833 -0.099088103839953354;-0.015471569893576497 0.0098169964871813245;-0.045865797229079186 0.031581971572881756;-0.77122738991483164 0.96156411590117785;0.21600414172796281 -0.11427413116888196;0.027335900243102385 -0.023734374679312061;-0.071279609616708123 0.045112715000990268;-0.74142062226603977 -0.10961888919075942];
IW1_2 = [-0.13093835556025171 0.60165513243933533 -0.53030065508993818 1.0013114060271457 -0.51186187839974429 1.4702147376859727 0.20572197235495923 -0.032493862251103643;0.23036896284086361 -0.73107259845135086 -0.13485276441810767 -0.23843849317102489 0.84186620141173096 -0.22247439182306236 0.51938771838888154 0.032524378874857311;0.21711596945547201 -0.54409777139513837 -0.77715675422407648 0.28491185248635809 -0.55322386954561342 0.2066424321848972 0.57926907846547049 -1.1173839219967632;-0.16900304817164907 -0.2552699176415042 -0.016377715879342825 0.020605501567387809 0.076003850644424831 -0.053489961044314652 -0.01764574628484003 0.032022022304451704;0.20280648480558378 -0.27816703375287827 -0.12082845573191228 -0.25288226449350887 0.25598300688459041 -0.23736355017087168 -0.05853589780667965 0.018370933046957715;-0.57178250187344648 0.35233811774623086 0.2297630163583041 -0.20099552027389936 0.35473246894199922 -0.0036162532380285446 -0.15277903721149511 0.3403664638627219;0.34971380488315962 -0.68613446462878525 -0.28778874295967977 -0.3359014342906585 -0.35582256334923668 -0.16195706657639394 0.17404028613276296 -0.63265166506885206;-0.81538994382217755 0.63747492193500555 -0.038032487521801828 -0.026378201490938839 -0.46960264541187685 0.54085036481174686 0.025696789285482694 0.195970171697496;-0.18952298555734023 0.14421360292455623 -0.27758810801480827 0.18273093727888662 0.14516621943146141 -0.019823843052408748 -0.074043204199792517 0.20157214040543336;0.076389253777951416 1.0049598485475242 -0.90080023319830804 -0.42321366248152897 0.15255316039947073 0.87786970732948877 -0.015086560126845904 0.45316346046974471];

% Layer 2
b2 = [0.78974604179405139;-0.030292131894573426;-0.36398133686884304;-0.56819354848550407];
LW2_1 = [-0.0067326008536049333 0.68630211318908063 -0.13395592518907345 -2.0693247063644367 -0.19144133828702897 -0.0076533702808021528 -0.13936881200553589 -0.67145434632161138 0.17307973071065061 -0.13510984247560234;0.15280974764412014 -0.38086934289336155 -0.096359931813866637 -2.3021000365819431 -0.1361498832348709 0.0042427024481797417 -0.072297046167172016 0.073919511453495165 0.36004880432192027 -0.39512396765176283;-1.0181841800803826 -0.066957490791788241 -0.76006781526826184 1.0833318721847998 -0.84342833591177768 0.052855425584939345 -0.91102070286552783 -0.057437805344287683 -2.0822335033676937 0.95803869164206168;0.2211920639401837 -0.50358260619653883 0.10973339386121859 0.9233378279104818 -2.992663849164487 0.0054415306900663044 0.16050134222486287 -1.3110889680796318 1.345973688885066 -0.09148968032858508];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.523617186407085;0.459064467788146;0.223430193966737;0.127210752845805];
y1_step1.xoffset = [-1.89414184126235;-2.36502124594879;-4.45419934918392;-7.44556467563318];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(1,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(4,1)];

% Allocate Outputs
y1 = zeros(4,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),2,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),8,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end

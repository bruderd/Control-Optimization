function [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 13-Aug-2018 10:23:31.
%
% [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 1xTS matrix, input #1
%   x2 = 4xTS matrix, input #2
%   xi1 = 1x2 matrix, initial 2 delay states for input #1.
%   xi2 = 4x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 4xTS matrix, output #1
%   xf1 = 1x2 matrix, final 2 delay states for input #1.
%   xf2 = 4x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = -4.6717360824591;
x1_step1.gain = 0.21435731223679;
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-1.82979317956921;-1.82938523205877;-4.3320556590986;-7.30947114336081];
x2_step1.gain = [0.578702340381178;0.521918596515984;0.24687382882873;0.1541885251259];
x2_step1.ymin = -1;

% Layer 1
b1 = [-1.8699504292855491;-2.5342242553723482;0.41636744876151471;0.088900168430725277;0.099568614858983176;-0.097700373285576111;0.69944499221211265;-0.35759010262063595;-0.040031565925570639;1.7363649534510155];
IW1_1 = [0.43863076877513962 0.57580048879196777;0.85981978769316592 0.97147632614701285;-0.88402230764789591 0.65781139367309893;-0.029250969943043333 0.11091006460816311;-0.0054400970477622122 0.18565304712426947;-0.39341197759488444 -0.24057914953414447;1.2401154951384479 -0.31120707313881213;0.29519624426126245 -0.24209958103135357;-0.26577240695458282 0.54252493832071946;0.496398260151517 -0.6397759144836429];
IW1_2 = [-1.030022535862779 0.62580131662315541 -0.55690820162596166 0.90405526762740551 -0.17945585271908915 0.31058106352866527 0.19116864697945407 0.68900428905818445;0.65115014734758314 -0.29134055990228402 -0.39566693351845489 -0.54054383992720301 0.51516053096579084 -1.2360729426000883 0.44881519231643013 0.31015850940433937;0.15685116651352593 0.059777009166089315 -0.56737683479242751 0.0079223166220567763 0.19223278898609616 -0.094301577084274807 0.59787917761249165 0.14441904439004077;-0.34214461360134335 0.43767930114055831 0.073746183250125358 -0.060841885072015663 -0.5345959487645221 0.27381450538130714 -0.13238923684022819 0.042009155873828696;-0.41180205206071002 -0.058544042647788889 0.27719701601629071 -0.51396965569796915 0.19960099856841054 0.40072431040237289 -0.93476644319897273 -0.16661760369844164;0.49591966906334567 -0.45509170641905944 -0.3015163202798582 0.49512260549530085 -0.32115054726035153 -0.44955914850730866 0.7264711098174198 0.078029852431291416;-0.36901070500196159 0.80195839528181234 -0.59898221620260472 0.82425253494601347 -0.44441230521023628 -0.0087645654653610849 -0.085129227604146873 -0.48351030511622733;0.17423012736852861 -0.033024802019290249 -0.1125123248128277 -0.24268149973829289 0.16111388035324492 -0.0045536463010854584 -0.02941941791076676 -0.0074590419280513498;-0.84109723048501872 0.65539178298395273 -1.2710832079610901 0.26919209179161574 -0.58065401279945605 -0.35764697383518002 0.97791686386491183 -0.19449053190886514;-0.26268501414790785 -0.38459385727587364 0.59191412421690792 -0.024725941843615554 -0.19096138363452803 0.016359778820736481 -0.35230060229167298 -0.11392442258275073];

% Layer 2
b2 = [0.37656116045060045;0.32792135516065835;0.13756106654335559;0.22799909160411613];
LW2_1 = [0.01680788555600804 0.064948138877505071 0.86600296354749584 -0.35319970153833941 -0.36323942644795415 -0.52561322499328145 -0.029827058469116915 0.15697355849775857 -0.26571517729043237 -0.61992468493057462;0.076556975993879339 0.063757098397313833 1.379194772611803 0.96569213347399063 -0.21725009807839327 -0.39899779457805673 0.11358443645045185 0.036602702760403269 -0.38483963761687701 -0.99705903356725323;-0.29482190513377765 0.25167304962233439 -1.0302586566336149 0.088959947459290589 -1.363063399995651 -1.1899118319035464 -0.84593743648635966 -1.342044851857968 0.085984170879967722 0.3024647631261389;0.3594744926840539 0.09291905027374027 0.39128292785466678 -0.72673195747943686 0.33205075653485677 0.43009018050530284 0.73895889809141657 -2.3042327608940698 -0.4956827298945003 -1.2387771639345677];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.578702340381178;0.521918596515984;0.24687382882873;0.1541885251259];
y1_step1.xoffset = [-1.82979317956921;-1.82938523205877;-4.3320556590986;-7.30947114336081];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(1,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(4,1)];

% Allocate Outputs
y1 = zeros(4,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),2,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),8,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end

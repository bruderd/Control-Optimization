%% Calculate dfdx, dfdxdot from f (only the second & third row of f)
% v4: Tension only needs one case!

clear

syms r0 L0 gama0 betta0 P gama betta r L dP dgama dbetta dr dL c1 c2 c3 c4 c5 c6 x u phi dphi nrat

x = [P gama betta r L phi];
xdot = [dP dgama dbetta dr dL dphi];


%% Dynamics
f_same = [-dP + 0.5*(u - P);...  % The constant in front of (u-P) is arbitrary 
     pi*r^2*dP - c1*dL + 2*pi*P*r*dr + (4*pi*P*r^2*dgama*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*dbetta*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) - (4*pi*cos(gama)*r^2*dP*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) + (4*pi*cos(gama)*P*r^2*(2*dgama*(cot(gama)^2 + 1) - dbetta*(cot(betta)^2 + 1) + cos((pi*tan(betta))/tan(gama))*dbetta*(cot(betta)^2 + 1) + sin((pi*tan(betta))/tan(gama))*cot(betta)*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (4*pi*cos(betta)*r^2*dP*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (4*pi*cos(betta)*P*r^2*(dgama*(cot(gama)^2 + 1) - 2*dbetta*(cot(betta)^2 + 1) - cos(pi*(nrat - tan(gama)/tan(betta)))*dgama*(cot(gama)^2 + 1) + 2*nrat*dgama*(cot(gama)^2 + 1) + pi*cot(gama)*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (4*pi*cos(betta)*P*r^2*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2) + (4*pi*cos(gama)^2*P*r^2*dgama*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta)))/(sin(gama)^2*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) + (4*pi*cos(betta)^2*P*r^2*dbetta*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama)))/(sin(betta)^2*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (8*pi*cos(gama)*P*r*dr*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (8*pi*cos(betta)*P*r*dr*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (4*pi*cos(gama)*P*r^2*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2);...
     ((4*pi*P*r^2*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3))*dr - c4*dphi + r*((4*pi*r^2*dP*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) - (4*pi*P*r^2*(2*dgama*(cot(gama)^2 + 1) - dbetta*(cot(betta)^2 + 1) + cos((pi*tan(betta))/tan(gama))*dbetta*(cot(betta)^2 + 1) + sin((pi*tan(betta))/tan(gama))*cot(betta)*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*r^2*dP*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*(dgama*(cot(gama)^2 + 1) - 2*dbetta*(cot(betta)^2 + 1) - cos(pi*(nrat - tan(gama)/tan(betta)))*dgama*(cot(gama)^2 + 1) + 2*nrat*dgama*(cot(gama)^2 + 1) + pi*cot(gama)*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2 + (8*pi*P*r*dr*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (8*pi*P*r*dr*(2*cot(betta) - cot(gama) - 2*nrat*cot(gama) + cos(pi*(nrat - tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*(2*cot(gama) - cot(betta) + cos((pi*tan(betta))/tan(gama))*cot(betta))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat - tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat - tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat - tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2);...
     dL/cos(gama) + ((phi - (L0*tan(gama0))/r0)*dr)/sin(gama) + (r*dphi)/sin(gama) + (sin(gama)*L*dgama)/cos(gama)^2 - (cos(gama)*r*(phi - (L0*tan(gama0))/r0)*dgama)/sin(gama)^2;...
     dL/cos(betta) + ((phi - (L0*tan(betta0))/r0)*dr)/sin(betta) + (r*dphi)/sin(betta) + (sin(betta)*L*dbetta)/cos(betta)^2 - (cos(betta)*r*(phi - (L0*tan(betta0))/r0)*dbetta)/sin(betta)^2;...
     (tan(gama)*L*dr)/r^2 - (tan(gama)*dL)/r - (L*(tan(gama)^2 + 1)*dgama)/r - dphi];


f_dif = [-dP + 0.5*(u - P);...  % The constant in front of (u-P) is arbitrary 
    pi*r^2*dP - c1*dL + 2*pi*P*r*dr + (4*pi*P*r^2*dgama*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*dbetta*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*cos(gama)*P*r^2*(dbetta*(cot(betta)^2 + 1) + 2*dgama*(cot(gama)^2 + 1) - cos((pi*tan(betta))/tan(gama))*dbetta*(cot(betta)^2 + 1) - sin((pi*tan(betta))/tan(gama))*cot(betta)*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) + (4*pi*cos(betta)*P*r^2*(2*dbetta*(cot(betta)^2 + 1) + dgama*(cot(gama)^2 + 1) - cos(pi*(nrat + tan(gama)/tan(betta)))*dgama*(cot(gama)^2 + 1) + 2*nrat*dgama*(cot(gama)^2 + 1) - pi*cot(gama)*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (4*pi*cos(gama)*r^2*dP*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (4*pi*cos(betta)*r^2*dP*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) + (4*pi*cos(betta)^2*P*r^2*dbetta*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama)))/(sin(betta)^2*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (8*pi*cos(gama)*P*r*dr*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (8*pi*cos(betta)*P*r*dr*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)) - (4*pi*cos(gama)*P*r^2*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(sin(gama)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2) - (4*pi*cos(betta)*P*r^2*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(sin(betta)*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2) + (4*pi*cos(gama)^2*P*r^2*dgama*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta)))/(sin(gama)^2*(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3));...
    ((4*pi*P*r^2*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3))*dr - c4*dphi + r*((4*pi*r^2*dP*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) - (4*pi*P*r^2*(dbetta*(cot(betta)^2 + 1) + 2*dgama*(cot(gama)^2 + 1) - cos((pi*tan(betta))/tan(gama))*dbetta*(cot(betta)^2 + 1) - sin((pi*tan(betta))/tan(gama))*cot(betta)*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*r^2*dP*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) - (4*pi*P*r^2*(2*dbetta*(cot(betta)^2 + 1) + dgama*(cot(gama)^2 + 1) - cos(pi*(nrat + tan(gama)/tan(betta)))*dgama*(cot(gama)^2 + 1) + 2*nrat*dgama*(cot(gama)^2 + 1) - pi*cot(gama)*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (8*pi*P*r*dr*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (8*pi*P*r*dr*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3) + (4*pi*P*r^2*(cot(betta) + 2*cot(gama) - cos((pi*tan(betta))/tan(gama))*cot(betta))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2 + (4*pi*P*r^2*(2*cot(betta) + cot(gama) + 2*nrat*cot(gama) - cos(pi*(nrat + tan(gama)/tan(betta)))*cot(gama))*(sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + pi*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2) - sin((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta)))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) + 2*nrat*sin((pi*tan(betta))/tan(gama))*((pi*(tan(betta)^2 + 1)*dbetta)/tan(gama) - (pi*tan(betta)*(tan(gama)^2 + 1)*dgama)/tan(gama)^2) - pi*cos((pi*tan(betta))/tan(gama))*sin(pi*(nrat + tan(gama)/tan(betta)))*(((tan(gama)^2 + 1)*dgama)/tan(betta) - (tan(gama)*(tan(betta)^2 + 1)*dbetta)/tan(betta)^2)))/(cos((pi*tan(betta))/tan(gama)) - 2*nrat + cos(pi*(nrat + tan(gama)/tan(betta))) - cos((pi*tan(betta))/tan(gama))*cos(pi*(nrat + tan(gama)/tan(betta))) + 2*nrat*cos((pi*tan(betta))/tan(gama)) + 3)^2);...
    dL/cos(gama) + ((phi - (L0*tan(gama0))/r0)*dr)/sin(gama) + (r*dphi)/sin(gama) + (sin(gama)*L*dgama)/cos(gama)^2 - (cos(gama)*r*(phi - (L0*tan(gama0))/r0)*dgama)/sin(gama)^2;...
    dL/cos(betta) + ((phi - (L0*tan(betta0))/r0)*dr)/sin(betta) + (r*dphi)/sin(betta) + (sin(betta)*L*dbetta)/cos(betta)^2 - (cos(betta)*r*(phi - (L0*tan(betta0))/r0)*dbetta)/sin(betta)^2;...
    (tan(gama)*L*dr)/r^2 - (tan(gama)*dL)/r - (L*(tan(gama)^2 + 1)*dgama)/r - dphi];

    
%% Calculate gradients
f1 = [f_same(1), f_dif(1)];
f2 = [f_same(2), f_dif(2)];
f3 = [f_same(3), f_dif(3)];
f4 = [f_same(4), f_dif(4)];
f5 = [f_same(5), f_dif(5)];
f6 = [f_same(6), f_dif(6)];

for k = 1:2
    
    df1dx = jacobian(f1(k), x);
    df1dxdot = jacobian(f1(k), xdot);
    
    df2dx = jacobian(f2(k), x);
    df2dxdot = jacobian(f2(k), xdot);
    
    df3dx = jacobian(f3(k), x);
    df3dxdot = jacobian(f3(k), xdot);
    
    df4dx = jacobian(f4(k), x);
    df4dxdot = jacobian(f4(k), xdot);
    
    df5dx = jacobian(f5(k), x);
    df5dxdot = jacobian(f5(k), xdot);
    
    df6dx = jacobian(f6(k), x);
    df6dxdot = jacobian(f6(k), xdot);
    
    % Put these together into dfdx, dfdxdot
    dfdx(:,:,k) = [df1dx; df2dx; df3dx; df4dx; df5dx; df6dx];
    dfdxdot(:,:,k) = [df1dxdot; df2dxdot; df3dxdot; df4dxdot; df5dxdot; df6dxdot];

end